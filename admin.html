<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶Å Admin Lion App - SALVA AUTOMATICO</title>
    <style>
        /* (MANTIENI TUTTO LO STILE PRECEDENTE) */
        /* ... stesso CSS dell'admin organizzato ... */
        
        /* Aggiungi solo questo: */
        .github-token {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #0366d6;
        }
        
        .github-token input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .github-token small {
            color: #666;
            display: block;
            margin-top: 5px;
        }
        
        .btn-save-auto {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü¶Å Admin Lion App - SALVA DIRETTO SU GITHUB</h1>
        <p>Modifica e salva automaticamente su GitHub!</p>
    </div>
    
    <!-- SEZIONE TOKEN GITHUB (DA FARE UNA VOLTA) -->
    <div class="github-token">
        <h3>üîê Configurazione GitHub (solo una volta)</h3>
        <p>Per salvare automaticamente, crea un token GitHub:</p>
        <ol>
            <li>Vai a: <a href="https://github.com/settings/tokens" target="_blank">GitHub Tokens</a></li>
            <li>Clicca "Generate new token" ‚Üí "Generate new token (classic)"</li>
            <li>Nome: <code>Lion-App-Token</code></li>
            <li>Seleziona: <strong>repo</strong> (tutto sotto repo)</li>
            <li>Clicca "Generate token"</li>
            <li><strong>COPIA IL TOKEN</strong> (lo vedi solo una volta!)</li>
        </ol>
        
        <label>Incolla il tuo token qui (salva nel browser):</label>
        <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        <button onclick="saveToken()">üíæ Salva Token Localmente</button>
        <small>Il token viene salvato SOLO nel tuo browser, non su server.</small>
    </div>
    
    <!-- RESTANTE FORM (UGUALE A PRIMA) -->
    <!-- ... tutte le sezioni della config ... -->
    
    <!-- PULSANTI AGGIORNATI -->
    <div class="action-buttons">
        <button class="btn btn-reset" onclick="resetToDefault()">
            üîÑ Reset
        </button>
        
        <button class="btn btn-secondary" onclick="loadFromGitHub()">
            üì• Carica Config
        </button>
        
        <button class="btn btn-save-auto" onclick="saveToGitHubAuto()">
            üöÄ Salva Automatico su GitHub
        </button>
        
        <button class="btn btn-primary" onclick="showJsonForManual()">
            üìã Copia per Salvataggio Manuale
        </button>
    </div>
    
    <!-- STATUS AGGIORNATO -->
    <div class="preview-section">
        <div class="status-bar">
            <span>Stato:</span>
            <span class="status" id="configStatus">Pronto</span>
        </div>
        <pre id="jsonPreview">{}</pre>
    </div>

    <script>
        // 1. GESTIONE TOKEN (salvato localmente)
        const TOKEN_KEY = 'github_token_lionapp';
        
        function saveToken() {
            const token = document.getElementById('githubToken').value;
            if (token && token.startsWith('ghp_')) {
                localStorage.setItem(TOKEN_KEY, token);
                alert('‚úÖ Token salvato nel browser!');
            } else {
                alert('‚ùå Token non valido. Deve iniziare con ghp_');
            }
        }
        
        function getToken() {
            return localStorage.getItem(TOKEN_KEY);
        }
        
        // 2. FUNZIONE SALVATAGGIO AUTOMATICO
        async function saveToGitHubAuto() {
            const status = document.getElementById('configStatus');
            const token = getToken();
            
            if (!token) {
                status.textContent = '‚ùå Token non configurato';
                status.className = 'status status-error';
                alert('Prima configura il token GitHub! Leggi le istruzioni sopra.');
                return;
            }
            
            status.textContent = 'üîÑ Invio a GitHub...';
            status.className = 'status';
            
            const config = currentConfig; // La tua configurazione corrente
            
            try {
                // A. Prima ottieni info sul file esistente
                const getResponse = await fetch(
                    'https://api.github.com/repos/mauri63/Mauri/contents/config.json',
                    {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                let sha = null;
                if (getResponse.ok) {
                    const fileInfo = await getResponse.json();
                    sha = fileInfo.sha;
                }
                
                // B. Prepara i dati per l'update
                const content = JSON.stringify(config, null, 2);
                const contentBase64 = btoa(unescape(encodeURIComponent(content)));
                
                const updateData = {
                    message: `ü¶Å Aggiornamento config Lion App - ${new Date().toLocaleString()}`,
                    content: contentBase64,
                    branch: 'main'
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                // C. Invia l'update
                const putResponse = await fetch(
                    'https://api.github.com/repos/mauri63/Mauri/contents/config.json',
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );
                
                if (putResponse.ok) {
                    status.textContent = '‚úÖ Salvato su GitHub!';
                    status.className = 'status status-success';
                    
                    // Notifica
                    alert(`üéâ Configurazione salvata con successo su GitHub!\n\nL'aggiornamento apparir√† nell'app tra pochi secondi.`);
                    
                    // Aggiorna preview
                    updatePreview();
                    
                } else {
                    const error = await putResponse.json();
                    throw new Error(error.message || 'Errore GitHub API');
                }
                
            } catch (error) {
                console.error('Errore salvataggio:', error);
                status.textContent = '‚ùå Errore: ' + error.message;
                status.className = 'status status-error';
                
                alert(`‚ùå Errore nel salvataggio automatico:\n\n${error.message}\n\nUsa il metodo manuale (Copia/Incolla).`);
            }
        }
        
        // 3. FUNZIONE PER COPIA MANUALE (backup)
        function showJsonForManual() {
            const config = currentConfig;
            const jsonStr = JSON.stringify(config, null, 2);
            
            // Crea un textarea per copiare facilmente
            const textarea = document.createElement('textarea');
            textarea.value = jsonStr;
            textarea.style.position = 'fixed';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('‚úÖ JSON copiato negli appunti!\n\nOra:\n1. Vai su https://github.com/mauri63/Mauri\n2. Clicca config.json ‚Üí Edit\n3. Incolla (Ctrl+V) ‚Üí Commit');
                } else {
                    alert('‚ùå Impossibile copiare. Ecco il JSON:\n\n' + jsonStr);
                }
            } catch (err) {
                alert('JSON da copiare:\n\n' + jsonStr);
            }
            
            document.body.removeChild(textarea);
        }
        
        // 4. INIZIALIZZAZIONE
        document.addEventListener('DOMContentLoaded', function() {
            // Carica token se esiste
            const savedToken = getToken();
            if (savedToken) {
                document.getElementById('githubToken').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            }
            
            // Inizializza il resto
            initPage();
        });
        
        // [MANTIENI TUTTE LE ALTRE FUNZIONI DEL PANNELO PRECEDENTE]
        // initPage(), setupColorPickers(), addLink(), addContent(), etc...
        // ... tutto il resto del codice JavaScript ...
        
    </script>
</body>
</html>
